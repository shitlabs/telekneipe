<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimum-scale=1, width=device-width, height=device-height">
    <meta name="description" content="The only thing we know about cyberspace is that is serves Sterni">
    <meta name="author" content="shitcrew">

    <title>T*E*L*E*K*N*E*I*P*E</title>

    <link rel="stylesheet" href="css/fabulation.css">
    <link rel="stylesheet" href="css/telekneipe.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
    <script src="https://unpkg.com/peerjs@1.2.0/dist/peerjs.min.js"></script>
    <script type="text/javascript" src="js/seriously.js"></script>
    <script type="text/javascript" src="https://brianchirls.github.io/Seriously.js/effects/seriously.brightness-contrast.js"></script>
    <script type="text/javascript" src="https://brianchirls.github.io/Seriously.js/effects/seriously.pixelate.js"></script>
    <script type="text/javascript" src="https://brianchirls.github.io/Seriously.js/effects/seriously.hue-saturation.js"></script>
    <script type="text/javascript" src="https://pixijs.download/release/pixi.min.js"></script>
    <script type="text/javascript" src="js/fabulation.js"></script>
    
  </head>

  <body>
    <!-- Beta Warning Modal -->
    <div class="modal modal-warn-background" id="betaWarning">
      <div class="modal-content">
        <div class="modal-content-header">
          <span class="close" id="betaWarningButton">&times;</span>
          <h3 id="modalHeader">Experimental Branch</h3>
        </div>
        <div class="modal-content-body" id="modalBody">
          Dies ist die Developer Version der Telekneipe. Zur aktuellen Stabilen Version bitte auf <a href="https://www.telekneipe.de">www.telekneipe.de</a>
          <div id="modalWarning">Die Version ist zur Stable Branch nicht kompatibel!</div>        
        </div>
      </div>
    </div>
    <!-- TELEKNEIPE Modals -->    
    <div class="telekneipe_container">
      <div id="hwaccess">
          <p>Please click `allow` on the top of the screen so we can access your webcam and microphone for transmission.</p>
          <div id="hwaccess-retry">
            <p>Failed to access the webcam and microphone. </p>
            <a href="#" class="pure-button pure-button-error" id="hwaccess-retry-button">Try again</a>
          </div>
          <div id="hwaccess-error">
            <h3>Unable to access your devices. Please check they are connected and not used otherwise, then reload this page.</h3>
          </div>

      </div>
      <div id="call_pad">
        <h3>"Who are you looking for?"</h3>
        <div class="pure-form">
          <input type="text" placeholder="User id..." id="callto-id">
          <a href="#" class="clickbutton" id="make-call">Have a look</a>
        </div>
      </div>
      <div id="table_container">     
        <div id="video-container">
          <canvas id="screen"></canvas>
        </div>
      </div>
    </div>

    <div class="bg">
    </div>
    <div class="content" id="catch_events">


      <!-- FABULATION -->
        <div class="disp">
        </div>
        <div class="center-scene">
              {% for scene in contexts %}
              <div id="{{ scene.id }}" style="display: none;">
              {{ scene.content }}
              </div>
              {% endfor %}
        </div>
    </div>
    <div class="receipt">
      <div class="receipt-top"></div>
      <div class="receipt-header">
        ID: <span id="receiptId"></span>
        <img class="receipt-close" id="receiptButton" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAKUlEQVQImWP4//Hh//8fH/5nYGD4D2fDBGAYymdAUcnAwABRiVU7uiAA1xdF+JdYbBgAAAAASUVORK5CYII=">
      </div>
      <div class="receipt-peers" id="receiptPeers" />
      <div id="console">
      </div>
    </div>

    <script type="module">
        import {Telekneipe} from "./js/telekneipe.js";
        
        var meta = {{ meta }};

        var table;


        $(function() {
            var fab = start_fabulation(meta);
            try {
              table = new Telekneipe(true);              
              table.registerUI();
              $.exposed = {table:table};
              if (table.lang == "en" && window.location.pathname.includes("index.html")) {
                window.location.replace("./index_en.html");
              }
              if (table.lang == "de" && window.location.pathname.includes("index_en.html")) {
                window.location.replace("./index.html");
              }

            } catch (err) {
              if (err.message.includes("WebGL unsupported")) {
                $("#modalWarning").html("Fehler: Dein Browser unterstützt keine WebGL. Bitte nutze die <a href=\"https://mini.telekneipe.de/\"> Telekneipe-Minibar.</a>");  
              }
              else {
                $("#modalWarning").text(`Warnung: Während der Initialisierung wurde ein unerwarteter Fehler festgestellt. Fehlermeldung: ${err}.`);
                throw(err);
              }
            } finally {
              if (table) {
                if (table.skipFrequent) {
                  fab(meta["{{ frequent }}"])
                } else if (table.skipCookies) {
                  fab(meta["{{ cookies }}"])
                } else {
                  fab(meta["{{ root }}"]);
                }
              } else {
                fab(meta["{{ root }}"]);
              }
            }

            // temporarily display info after first screen
            $('#catch_events').on("tableservice.about", function() {
              if (table && table.skipCookies) {
                table.clubMarke()
              } else {
                $("#betaWarning").show();
              }
            });            
            // info box functionality
            $(".modal-content").on('click', (event) => (event.stopPropagation()));            
            $("#betaWarningButton").click(function() {
              $("#betaWarning").fadeOut("slow");
            });
            $("#betaWarning").click('click',()=>{$("#betaWarning").fadeOut("slow");});
            // receipt functionality.
            $("#receiptButton").click(function() {
              $("#console").toggle();
              let deg = $(this).data('rotate');
              let rotate = deg ? 'rotate(0deg)' : 'rotate(180deg)';
              $(this).css({ 
                '-webkit-transform': rotate,
                '-moz-transform': rotate,
                '-o-transform': rotate,
                '-ms-transform': rotate,
                'transform': rotate 
              });
              $(this).data('rotate', !deg);
            });            
        });

    </script>
  </body>
</html>
